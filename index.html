<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>F1 Start Reaction</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Orbitron', sans-serif;
}

body {
  background: #000;
  color: white;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  transition: 0.3s ease;
}

body.red-mode {
  box-shadow: inset 0 0 120px red;
  border: 8px solid red;
}

.timer {
  font-size: 60px;
  margin-bottom: 20px;
  letter-spacing: 3px;
  cursor: pointer;
}

.best {
  margin-bottom: 30px;
  font-size: 14px;
  opacity: 0.7;
}

.lights {
  display: flex;
  gap: 20px;
  margin-bottom: 40px;
}

.light {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: #220000;
  transition: 0.2s;
}

.light.on {
  background: red;
  box-shadow: 0 0 25px red;
}

button {
  padding: 8px 20px;
  background: #111;
  color: white;
  border: 1px solid #333;
  border-radius: 20px;
  cursor: pointer;
  margin: 5px;
}

button:hover {
  background: #222;
}

/* Leaderboard Button Top Right */
#leaderBtn {
  position: absolute;
  top: 20px;
  right: 20px;
}

/* Username Modal */
#nameModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.95);
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  z-index: 1000;
}

#nameModal input {
  padding: 10px;
  border-radius: 5px;
  border: none;
  margin-bottom: 15px;
}
</style>
</head>
<body>

<!-- Leaderboard Button -->
<button id="leaderBtn" onclick="goLeaderboard()">Leaderboard</button>

<!-- Username Popup -->
<div id="nameModal">
  <h2 style="margin-bottom:20px;">Enter Your Name</h2>
  <input id="playerName" type="text" placeholder="Your name">
  <button onclick="startGame()">Start Game</button>
</div>

<div class="timer" id="timer">00.000</div>
<div class="best">Best: <span id="best">--</span></div>

<div class="lights">
  <div class="light"></div>
  <div class="light"></div>
  <div class="light"></div>
  <div class="light"></div>
  <div class="light"></div>
</div>

<button onclick="manualReset()">RETRY</button>

<script>
const lights = document.querySelectorAll(".light");
const timerDisplay = document.getElementById("timer");
const bestDisplay = document.getElementById("best");

let state = "idle";
let startTime;
let timerInterval;
let countdownInterval;
let goTimeout;
let bestTime = null;
let currentLight = 0;
let username = "";

let audioCtx;

// Unlock audio on first interaction
document.body.addEventListener("click", () => {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}, { once: true });

document.body.addEventListener("click", function(e) {
  if (e.target.tagName === "BUTTON" || e.target.id === "playerName") return;
  if(document.getElementById("nameModal").style.display !== "none") return;
  handleClick();
});

function startGame() {
  const input = document.getElementById("playerName").value.trim();
  if(input === ""){
    alert("Enter your name!");
    return;
  }
  username = input;
  document.getElementById("nameModal").style.display = "none";
}

function playBeep(lightIndex) {
  const oscillator = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  oscillator.type = "sine";
  oscillator.frequency.value = 600 + (lightIndex * 120);
  gain.gain.value = 0.2;
  oscillator.connect(gain);
  gain.connect(audioCtx.destination);
  oscillator.start();
  oscillator.stop(audioCtx.currentTime + 0.1);
}

function playGoSound() {
  const oscillator = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  oscillator.type = "square";
  oscillator.frequency.value = 1000;
  gain.gain.value = 0.3;
  oscillator.connect(gain);
  gain.connect(audioCtx.destination);
  oscillator.start();
  oscillator.stop(audioCtx.currentTime + 0.2);
}

function handleClick() {
  if (state === "idle") startSequence();
  else if (state === "countdown") falseStart();
  else if (state === "running") stopTimer();
}

function startSequence() {
  resetVisuals();
  state = "countdown";
  currentLight = 0;
  document.body.classList.add("red-mode");

  countdownInterval = setInterval(() => {
    if (currentLight < lights.length) {
      lights[currentLight].classList.add("on");
      playBeep(currentLight);
      currentLight++;
    } else {
      clearInterval(countdownInterval);
      let randomDelay = Math.random() * 3000 + 2000;

      goTimeout = setTimeout(() => {
        lights.forEach(light => light.classList.remove("on"));
        document.body.classList.remove("red-mode");
        playGoSound();
        startTimer();
      }, randomDelay);
    }
  }, 900);
}

function startTimer() {
  state = "running";
  startTime = performance.now();

  timerInterval = setInterval(() => {
    let time = (performance.now() - startTime) / 1000;
    timerDisplay.textContent = time.toFixed(3);
  }, 10);
}

function stopTimer() {
  clearInterval(timerInterval);
  state = "idle";
  let finalTime = parseFloat(timerDisplay.textContent);

  if (!bestTime || finalTime < bestTime) {
    bestTime = finalTime;
    bestDisplay.textContent = bestTime.toFixed(3);
  }

  saveScore(username, finalTime);
}

function falseStart() {
  clearInterval(countdownInterval);
  clearTimeout(goTimeout);
  state = "idle";
  timerDisplay.textContent = "FALSE START";
  document.body.classList.remove("red-mode");
  resetLights();
}

function manualReset() {
  clearInterval(timerInterval);
  clearInterval(countdownInterval);
  clearTimeout(goTimeout);
  state = "idle";
  document.body.classList.remove("red-mode");
  resetVisuals();
}

function resetLights() {
  lights.forEach(light => light.classList.remove("on"));
}

function resetVisuals() {
  timerDisplay.textContent = "00.000";
  resetLights();
}

function saveScore(name, time) {
  let scores = JSON.parse(localStorage.getItem("f1Scores")) || [];

  // Check if user already exists
  let existingUser = scores.find(score => score.name.toLowerCase() === name.toLowerCase());

  if (existingUser) {
    // Update only if new time is better
    if (time < existingUser.time) {
      existingUser.time = time;
    }
  } else {
    // Add new user
    scores.push({ name, time });
  }

  // Sort and keep top 10
  scores.sort((a, b) => a.time - b.time);
  scores = scores.slice(0, 10);

  localStorage.setItem("f1Scores", JSON.stringify(scores));
}


function goLeaderboard(){
  window.location.href = "leaderboard.html";
}
</script>

</body>
</html>
